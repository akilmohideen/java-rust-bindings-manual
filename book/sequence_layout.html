<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sequence Layout</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="title.html">Java Bindings for Rust: A Comprehensive Guide</a></li><li class="chapter-item expanded "><a href="cha01-00.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cha01-01.html"><strong aria-hidden="true">1.1.</strong> Purpose of the Manual</a></li><li class="chapter-item expanded "><a href="cha01-02.html"><strong aria-hidden="true">1.2.</strong> Why Java 22?</a></li><li class="chapter-item expanded "><a href="cha01-03.html"><strong aria-hidden="true">1.3.</strong> How Java and Rust Work Together</a></li><li class="chapter-item expanded "><a href="cha01-04.html"><strong aria-hidden="true">1.4.</strong> What This Manual Hopes to Accomplish</a></li></ol></li><li class="chapter-item expanded "><a href="cha02-00.html"><strong aria-hidden="true">2.</strong> Setting Up and Linking Rust and Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cha02-01.html"><strong aria-hidden="true">2.1.</strong> How Rust and Java Communicate</a></li><li class="chapter-item expanded "><a href="cha02-02.html"><strong aria-hidden="true">2.2.</strong> Setting Up Rust</a></li><li class="chapter-item expanded "><a href="cha02-03.html"><strong aria-hidden="true">2.3.</strong> Setting Up Java</a></li></ol></li><li class="chapter-item expanded "><a href="cha03-00.html"><strong aria-hidden="true">3.</strong> Mapping Rust Features to Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cha03-02.html"><strong aria-hidden="true">3.1.</strong> Handling Ownership and Borrowing</a></li><li class="chapter-item expanded "><a href="cha03-03.html"><strong aria-hidden="true">3.2.</strong> Memory Layouts and Structs</a></li><li class="chapter-item expanded "><a href="cha03-04.html"><strong aria-hidden="true">3.3.</strong> Handling Thread Safety in Rust</a></li></ol></li><li class="chapter-item expanded "><a href="cha04-00.html"><strong aria-hidden="true">4.</strong> Handling Common Data Structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cha04-01.html"><strong aria-hidden="true">4.1.</strong> Handling Rust Structs in Java</a></li><li class="chapter-item expanded "><a href="cha04-02.html"><strong aria-hidden="true">4.2.</strong> Handling Rust Arrays in Java</a></li><li class="chapter-item expanded "><a href="cha04-03.html"><strong aria-hidden="true">4.3.</strong> Handling Rust Vectors (Vec1) in Java</a></li><li class="chapter-item expanded "><a href="cha04-04.html"><strong aria-hidden="true">4.4.</strong> Handling Rust Slices (&[T] and &mut [T]) in Java</a></li></ol></li><li class="chapter-item expanded "><a href="cha05-00.html"><strong aria-hidden="true">5.</strong> Edge Cases and Troubleshooting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cha05-01.html"><strong aria-hidden="true">5.1.</strong> Handling Rust Lifetimes in Java</a></li><li class="chapter-item expanded "><a href="cha05-02.html"><strong aria-hidden="true">5.2.</strong> Handling Enums with Data Variants</a></li><li class="chapter-item expanded "><a href="cha05-03.html"><strong aria-hidden="true">5.3.</strong> WrongMethodTypeException in invokeExact()</a></li><li class="chapter-item expanded "><a href="cha05-04.html"><strong aria-hidden="true">5.4.</strong> Segmentation Fault or Undefined Behavior</a></li><li class="chapter-item expanded "><a href="cha05-05.html"><strong aria-hidden="true">5.5.</strong> UnsatisfiedLinkError When Loading Rust Shared Library</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Appendix</li><li class="chapter-item expanded "><a href="value_layout.html"><strong aria-hidden="true">6.</strong> Value Layout</a></li><li class="chapter-item expanded "><a href="method_handle.html"><strong aria-hidden="true">7.</strong> Method Handle</a></li><li class="chapter-item expanded "><a href="memory_layout.html"><strong aria-hidden="true">8.</strong> Memory Layout</a></li><li class="chapter-item expanded "><a href="memory_segment.html"><strong aria-hidden="true">9.</strong> Memory Segment</a></li><li class="chapter-item expanded "><a href="variable_handle.html"><strong aria-hidden="true">10.</strong> Variable Handle</a></li><li class="chapter-item expanded "><a href="function_descriptor.html"><strong aria-hidden="true">11.</strong> Function Descriptor</a></li><li class="chapter-item expanded "><a href="struct_layout.html"><strong aria-hidden="true">12.</strong> Struct Layout</a></li><li class="chapter-item expanded "><a href="union_layout.html"><strong aria-hidden="true">13.</strong> Union Layout</a></li><li class="chapter-item expanded "><a href="sequence_layout.html" class="active"><strong aria-hidden="true">14.</strong> Sequence Layout</a></li><li class="chapter-item expanded "><a href="arenas.html"><strong aria-hidden="true">15.</strong> Arena</a></li><li class="chapter-item expanded "><a href="so.html"><strong aria-hidden="true">16.</strong> Shared Object and Dynamic Library Files</a></li><li class="chapter-item expanded "><a href="ownership.html"><strong aria-hidden="true">17.</strong> Ownership</a></li><li class="chapter-item expanded "><a href="borrowing_and_aliasing.html"><strong aria-hidden="true">18.</strong> Borrowing and Aliasing</a></li><li class="chapter-item expanded "><a href="lifetimes.html"><strong aria-hidden="true">19.</strong> Lifetimes</a></li><li class="chapter-item expanded "><a href="sym_ex_gen.html"><strong aria-hidden="true">20.</strong> Symbols, Extern, and Generics</a></li><li class="chapter-item expanded "><a href="size_and_alignment.html"><strong aria-hidden="true">21.</strong> Size and Alignment</a></li><li class="chapter-item expanded "><a href="subtyping_and_variance.html"><strong aria-hidden="true">22.</strong> Subtyping and Variance</a></li><li class="chapter-item expanded "><a href="unwinding.html"><strong aria-hidden="true">23.</strong> Unwinding</a></li><li class="chapter-item expanded "><a href="phantom_data.html"><strong aria-hidden="true">24.</strong> Phantom Data</a></li><li class="chapter-item expanded "><a href="send_and_sync.html"><strong aria-hidden="true">25.</strong> Send and Sync</a></li><li class="chapter-item expanded "><a href="data_races.html"><strong aria-hidden="true">26.</strong> Data Races</a></li><li class="chapter-item expanded "><a href="atomics.html"><strong aria-hidden="true">27.</strong> Atomics</a></li><li class="chapter-item expanded "><a href="reordering.html"><strong aria-hidden="true">28.</strong> Compiler and Hardware Reordering</a></li><li class="chapter-item expanded "><a href="data_accesses.html"><strong aria-hidden="true">29.</strong> Data Accesses</a></li><li class="chapter-item expanded "><a href="orderings.html"><strong aria-hidden="true">30.</strong> Orderings</a></li><li class="chapter-item expanded "><a href="uninitialized_memory.html"><strong aria-hidden="true">31.</strong> Uninitialized Memory</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sequence-layout"><a class="header" href="#sequence-layout">Sequence Layout</a></h1>
<p><code>SequenceLayout</code> represents the layout of arrays. To create a
<code>SequenceLayout</code>, call <a href="memory_layout.html"><code>MemoryLayout</code></a><code>.sequenceLayout(numberOfElements, MemoryLayout)</code>. There is no get method or any direct way to get the nth
element of an array. Instead, create a special <a href="variable_handle.html"><code>VarHandle</code></a> to the needed
data within the member, then call get on that with the index. For instance, to
get the x-coordinates of the structs in an array, use:</p>
<pre><code class="language-java">SequenceLayout arrayOfStruct = MemoryLayout.sequenceLayout(10,
    MemoryLayout.structLayout(
        ValueLayout.JAVA_INT.withName(“x”),
        ValueLayout.JAVA_INT.withName(“y”)
    ).withName(“struct”)
);
VarHandle varHandle =
arrayOfStruct.arrayElementVarHandle(PathElement.groupElement(“x”));
for (int i=0; i&lt;10; i++) {
    System.out.println(varHandle.get(memorySegment, 
        0L,
        (long)i)
    );
}
</code></pre>
<p><code>SequenceLayout</code> provides some interesting <strong>methods</strong>.
<code>sequenceLayout.elementCount()</code> will, as the name suggests, give the
length of the array, which is useful for passing around slices as it is not necessary to store the length itself.
<code>sequenceLayout.reshape(long dim1, long dim2, …)</code> and <code>sequenceLayout.flatten()</code> are both related to reinterpreting
multidimensional arrays. Multidimensional arrays are just arrays of arrays,
but their layout means they can safely be reinterpreted as a single
dimension array of <a href="size_and_alignment.html">size</a> <code>(dim 1 size)*(dim 2 size)*...</code>, which is exactly what
<code>sequenceLayout.flatten()</code> does. <code>sequenceLayout.reshape</code> does the inverse of
<code>sequenceLayout.flatten()</code>, but is also fallible. Obviously, if an attempt is made to reshape
an array to AxBxC but the array’s length isn’t divisible by A and B and C, this
method will throw an exception. Another nice property of
<code>sequenceLayout.reshape()</code> is that one argument may be set to -1, in which
case <code>sequenceLayout.reshape()</code> will do the math based on the array’s length
to determine what that dimension must be.</p>
<p>A Java type can be used to act as a wrapper around <strong>Rust slices</strong>, so
<code>SequenceLayout</code> would feature heavily in that kind of implementation. While
a slice object, composed of a pointer and a length, is not application binary
interface (ABI) stable, the underlying array is ABI stable.
Rust provides methods to get the pointer and length from a slice, as well as
functions to construct slices from a pointer and a length, so while it is not
ABI safe, it is easy enough to disassemble and
reassemble into safe forms as needed. While it is easier to just keep an
opaque blob of data and ask Rust any time it must be used, it is much
faster for Java to have direct access to the array.</p>
<p>The <strong>Just-In-Time</strong> (JIT) compiler knows how array accesses work, and can optimize
the corresponding Java code, possibly with automatic vectorization which is
a great boost to throughput. In contrast, every time a call is made out to a Rust
function, the JIT compiler has no idea what that function is doing.
This means that it can not optimize the memory accesses, and it must also assume
that the function breaks every optimization assumption it has. For instance, the
function could touch any value in memory, preventing the JIT
compiler from reordering any reads or writes from before the function call to
after the function call, and vise versa.</p>
<p>The <strong>Rust compiler</strong> has the same issue: it
does not know what the Java code is doing, so there is no way it can optimize
around that such as automatic vectorization either. This does not matter so
much for one-off functions, functions that are only called a few thousand
times, or large functions where execution time is dominated by actually
running the function and not on function call overhead, but for simple code
in loops this can be brutal. And how are arrays typically
used? Usually small bits of code run many times in a loop. The performance
gains are too great to ignore. While doing the loop in Rust will beat Java
almost every time, it is not reasonable for every possible loop body to be put
in Rust. However, developers have the option to write all of their
loops in Rust if they so choose. Still, <code>SequenceLayout</code>
provides a great opportunity to allow easy, direct access to arrays and
array elements for Java.</p>
<p>For more information on <code>SequenceLayout</code>, visit Oracle's <a href="https://docs.oracle.com/en/java/javase/22/docs/api/java.base/java/lang/foreign/SequenceLayout.html">official documentation</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="union_layout.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="arenas.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="union_layout.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="arenas.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
